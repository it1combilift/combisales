generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  SELLER
}

enum AuthProvider {
  CREDENTIALS
  ZOHO
}

// ==================== CORE USER MODEL ====================
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?

  // Solo para autenticación por credenciales
  password String?

  // Metadatos de usuario
  image    String?
  role     Role    @default(SELLER)
  country  String?
  isActive Boolean @default(true)

  // Relaciones
  accounts Account[]
  sessions Session[]
  visits   Visit[] // Visitas realizadas por el vendedor

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([isActive])
}

// ==================== OAUTH ACCOUNTS MODEL ====================
// Almacena información de cuentas OAuth (Zoho, Google, etc.)
model Account {
  id                String @id @default(cuid())
  userId            String
  type              String // "oauth" | "oidc" | "email"
  provider          String // "zoho" | "credentials"
  providerAccountId String // ID del usuario en el proveedor (ZUID de Zoho)

  // OAuth Tokens
  refresh_token String? @db.Text
  access_token  String? @db.Text
  expires_at    Int? // Unix timestamp
  token_type    String?
  scope         String?
  id_token      String? @db.Text
  session_state String?

  // Zoho-specific metadata
  api_domain  String? // accounts.zoho.com, accounts.zoho.eu, etc.
  zoho_org_id String? // Organization ID de Zoho

  // Token refresh metadata
  token_refreshed_at DateTime? // Última vez que se refrescó el token
  token_expires_in   Int? // Segundos hasta expiración desde refresh

  // Relaciones
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@index([provider])
  @@index([expires_at])
}

// ==================== SESSION MODEL ====================
// Sesiones activas de usuarios (JWT sessions)
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  // Metadata de sesión
  ipAddress String?
  userAgent String?

  // Relaciones
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([expires])
}

// ==================== VERIFICATION TOKEN MODEL ====================
// Tokens para verificación de email, reset de contraseña, etc.
model VerificationToken {
  identifier String // Email o user ID
  token      String   @unique
  expires    DateTime
  type       String   @default("EMAIL_VERIFICATION") // EMAIL_VERIFICATION | PASSWORD_RESET

  createdAt DateTime @default(now())

  @@unique([identifier, token])
  @@index([expires])
}

// ==================== AUDIT LOG MODEL ====================
// Registro de eventos de autenticación para seguridad y debugging
model AuthAuditLog {
  id        String  @id @default(cuid())
  userId    String?
  email     String?
  event     String // LOGIN_SUCCESS | LOGIN_FAILED | TOKEN_REFRESH | LOGOUT | ACCOUNT_LINKED
  provider  String? // zoho | credentials
  ipAddress String?
  userAgent String?
  metadata  Json? // Datos adicionales en JSON

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([email])
  @@index([event])
  @@index([createdAt])
}

// ==================== CUSTOMER MODEL ====================
// Clientes sincronizados desde Zoho CRM
// Basado en la estructura completa de accounts-example.json
model Customer {
  id            String @id @default(cuid())
  zohoAccountId String @unique // ID de la cuenta en Zoho CRM

  // Información principal
  accountName   String // Account_Name
  razonSocial   String? // Razon_Social (nombre fiscal)
  accountNumber String? // Account_Number
  cif           String? // CIF/NIF (número identificación fiscal)
  codigoCliente String? // C_digo_Cliente (código interno)

  // Clasificación
  accountType String? // Account_Type (Cliente Final, Distribuidor, etc.)
  industry    String? // Industry (Construcción, Logística, etc.)
  subSector   String? // Sub_Sector

  // Contacto
  phone   String?
  fax     String?
  email   String? // Correo_electr_nico
  website String?

  // Dirección de facturación
  billingStreet  String?
  billingCity    String?
  billingState   String?
  billingCode    String?
  billingCountry String?

  // Dirección de envío
  shippingStreet  String?
  shippingCity    String?
  shippingState   String?
  shippingCode    String?
  shippingCountry String?

  // Geolocalización
  latitude  String? // dealsingooglemaps__Latitude
  longitude String? // dealsingooglemaps__Longitude

  // Propietario de la cuenta en Zoho
  zohoOwnerId    String?
  zohoOwnerName  String?
  zohoOwnerEmail String?

  // Creador de la cuenta en Zoho
  zohoCreatedById    String?
  zohoCreatedByName  String?
  zohoCreatedByEmail String?

  // Cuenta padre (si es subcuenta)
  parentAccountId   String?
  parentAccountName String?

  // Estados y flags booleanos
  clienteConEquipo        Boolean @default(false)
  cuentaNacional          Boolean @default(false)
  clienteBooks            Boolean @default(false)
  condicionesEspeciales   Boolean @default(false)
  proyectoAbierto         Boolean @default(false)
  revisado                Boolean @default(false)
  localizacionesMultiples Boolean @default(false)

  // Otros campos
  description       String? @db.Text
  comunidadAutonoma String?
  tipoPedido        String?
  estadoCuenta      String?

  // Metadatos de Zoho
  zohoCreatedAt    DateTime?
  zohoModifiedAt   DateTime?
  lastActivityTime DateTime?

  // Relaciones
  visits Visit[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([zohoAccountId])
  @@index([accountName])
  @@index([razonSocial])
  @@index([codigoCliente])
  @@index([createdAt])
}

// ==================== VISIT MODEL ====================
// Visitas realizadas por vendedores a clientes
enum VisitFormType {
  ANALISIS_CSS
  ANALISIS_INDUSTRIAL
  ANALISIS_LOGISTICA
  ANALISIS_STRADDLE_CARRIER
}

enum VisitStatus {
  BORRADOR
  COMPLETADA
  ENVIADA
  APROBADA
  RECHAZADA
}

model Visit {
  id         String        @id @default(cuid())
  customerId String
  userId     String
  formType   VisitFormType
  status     VisitStatus   @default(BORRADOR)
  visitDate  DateTime      @default(now())

  // Relaciones
  customer                          Customer                           @relation(fields: [customerId], references: [id], onDelete: Cascade)
  user                              User                               @relation(fields: [userId], references: [id], onDelete: Cascade)
  formularioCSSAnalisis             FormularioCSSAnalisis?
  formularioIndustrialAnalisis      FormularioIndustrialAnalisis?
  formularioLogisticaAnalisis       FormularioLogisticaAnalisis?
  formularioStraddleCarrierAnalisis FormularioStraddleCarrierAnalisis?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([userId])
  @@index([visitDate])
  @@index([status])
  @@index([formType])
}

// ==================== FORMULARIO CSS ANALYSIS MODEL ====================
// Formulario específico de Análisis CSS
enum ContenedorTipo {
  SOBRE_CAMION
  EN_SUELO
  INTERIOR
  EXTERIOR
}

enum ContenedorMedida {
  VEINTE_PIES
  TREINTA_PIES
  CUARENTA_PIES
  CUARENTA_Y_CINCO_PIES
  TODOS
  OTRO
}

// Enums para Formulario Industrial
enum TipoAlimentacion {
  ELECTRICO
  DIESEL
  GLP
}

enum TipoCorriente {
  MONOFASICA
  TRIFASICA
}

// Tipos de archivo permitidos en el formulario
enum TipoArchivo {
  IMAGEN
  VIDEO
  DOCUMENTO
}

model FormularioCSSAnalisis {
  id      String @id @default(cuid())
  visitId String @unique

  // 1. Datos del cliente
  datosClienteUsuarioFinal   String?
  razonSocial                String
  personaContacto            String
  email                      String
  direccion                  String
  localidad                  String
  provinciaEstado            String
  pais                       String
  codigoPostal               String?
  website                    String?
  numeroIdentificacionFiscal String?
  distribuidor               String?
  contactoDistribuidor       String?
  fechaCierre                DateTime?

  // 2. Descripción del producto
  descripcionProducto String @db.Text

  // 3. Datos del contenedor
  contenedorTipos       ContenedorTipo[]
  contenedoresPorSemana Int?
  condicionesSuelo      String?

  // 4. Medidas del contenedor
  contenedorMedida     ContenedorMedida
  contenedorMedidaOtro String?

  // 5. Archivos adjuntos (relación con FormularioArchivo)
  archivos FormularioArchivo[]

  visit Visit @relation(fields: [visitId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([visitId])
}

// ==================== FORMULARIO INDUSTRIAL ANALYSIS MODEL ====================
// Formulario específico de Análisis Industrial
model FormularioIndustrialAnalisis {
  id      String @id @default(cuid())
  visitId String @unique

  // 1. Datos del cliente
  razonSocial                String
  personaContacto            String
  email                      String
  direccion                  String
  localidad                  String
  provinciaEstado            String
  pais                       String
  codigoPostal               String
  website                    String?
  numeroIdentificacionFiscal String
  distribuidor               String?
  contactoDistribuidor       String?
  fechaCierre                DateTime?

  // 2. Descripción operación
  notasOperacion String @db.Text

  // 3. Datos aplicación
  descripcionProducto         String           @db.Text
  alturaUltimoNivelEstanteria Float?
  maximaAlturaElevacion       Float?
  pesoCargaMaximaAltura       Float?
  pesoCargaPrimerNivel        Float?
  dimensionesAreaTrabajoAncho Float?
  dimensionesAreaTrabajoFondo Float?
  turnosTrabajo               Int?
  fechaEstimadaDefinicion     DateTime?
  alimentacionDeseada         TipoAlimentacion

  // 4. Equipos eléctricos (JSON object with tipoCorriente, voltaje, frecuencia, etc.)
  equiposElectricos Json?

  // 5. Dimensiones cargas (JSON array of DimensionCarga objects)
  dimensionesCargas Json

  // 6. Especificaciones pasillo (JSON object with 12 measurement fields)
  especificacionesPasillo Json

  // 7. Archivos adjuntos (relación con FormularioArchivoIndustrial)
  archivos FormularioArchivoIndustrial[]

  visit Visit @relation(fields: [visitId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([visitId])
}

// ==================== ARCHIVOS DEL FORMULARIO INDUSTRIAL ====================
// Modelo para almacenar metadatos de archivos subidos a Cloudinary para Industrial Analysis
model FormularioArchivoIndustrial {
  id           String @id @default(cuid())
  formularioId String

  // Información del archivo
  nombre      String // Nombre original del archivo
  tipoArchivo TipoArchivo
  mimeType    String // application/pdf, image/jpeg, video/mp4, etc.
  tamanio     Int // Tamaño en bytes

  // Datos de Cloudinary
  cloudinaryId   String @unique // public_id de Cloudinary
  cloudinaryUrl  String // URL segura del archivo
  cloudinaryType String // image, video, raw (para documentos)

  // Metadatos adicionales
  ancho    Int? // Solo para imágenes/videos
  alto     Int? // Solo para imágenes/videos
  duracion Float? // Solo para videos (en segundos)
  formato  String // jpg, png, pdf, mp4, etc.

  formulario FormularioIndustrialAnalisis @relation(fields: [formularioId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([formularioId])
  @@index([tipoArchivo])
}

// ==================== FORMULARIO LOGÍSTICA ANALYSIS MODEL ====================
// Formulario específico de Análisis Logística
model FormularioLogisticaAnalisis {
  id      String @id @default(cuid())
  visitId String @unique

  // 1. Datos del cliente
  razonSocial                String
  personaContacto            String
  email                      String
  direccion                  String
  localidad                  String
  provinciaEstado            String
  pais                       String
  codigoPostal               String
  website                    String?
  numeroIdentificacionFiscal String
  distribuidor               String?
  contactoDistribuidor       String?
  fechaCierre                DateTime?

  // 2. Descripción operación
  notasOperacion     String  @db.Text
  tieneRampas        Boolean @default(false)
  notasRampas        String? @db.Text
  tienePasosPuertas  Boolean @default(false)
  notasPasosPuertas  String? @db.Text
  tieneRestricciones Boolean @default(false)
  notasRestricciones String? @db.Text
  alturaMaximaNave   Float?
  anchoPasilloActual Float?
  superficieTrabajo  Float?
  condicionesSuelo   String?
  tipoOperacion      String? // Almacenamiento, Cross-docking, Picking, etc.

  // 3. Datos aplicación
  descripcionProducto         String           @db.Text
  alturaUltimoNivelEstanteria Float?
  maximaAlturaElevacion       Float?
  pesoCargaMaximaAltura       Float?
  pesoCargaPrimerNivel        Float?
  dimensionesAreaTrabajoAncho Float?
  dimensionesAreaTrabajoFondo Float?
  turnosTrabajo               Int?
  fechaEstimadaDefinicion     DateTime?
  alimentacionDeseada         TipoAlimentacion

  // 4. Equipos eléctricos (JSON object with tipoCorriente, voltaje, frecuencia, etc.)
  // Solo aplica si alimentacionDeseada == ELECTRICO
  equiposElectricos Json?

  // 5. Dimensiones cargas (JSON array of DimensionCarga objects)
  // {producto, ancho, fondo, alto, peso, porcentaje}[]
  dimensionesCargas Json

  // 6. Pasillo actual (JSON object with distanciaEntreEstanterias, distanciaEntreProductos, etc.)
  pasilloActual Json

  // 7. Archivos adjuntos
  archivos FormularioArchivoLogistica[]

  visit Visit @relation(fields: [visitId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([visitId])
}

// ==================== ARCHIVOS DEL FORMULARIO LOGÍSTICA ====================
// Modelo para almacenar metadatos de archivos subidos a Cloudinary para Logística
model FormularioArchivoLogistica {
  id           String @id @default(cuid())
  formularioId String

  // Información del archivo
  nombre      String // Nombre original del archivo
  tipoArchivo TipoArchivo
  mimeType    String // application/pdf, image/jpeg, video/mp4, etc.
  tamanio     Int // Tamaño en bytes

  // Datos de Cloudinary
  cloudinaryId   String @unique // public_id de Cloudinary
  cloudinaryUrl  String // URL segura del archivo
  cloudinaryType String // image, video, raw (para documentos)

  // Metadatos adicionales
  ancho    Int? // Solo para imágenes/videos
  alto     Int? // Solo para imágenes/videos
  duracion Float? // Solo para videos (en segundos)
  formato  String // jpg, png, pdf, mp4, etc.

  formulario FormularioLogisticaAnalisis @relation(fields: [formularioId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([formularioId])
  @@index([tipoArchivo])
}

// ==================== ARCHIVOS DEL FORMULARIO ====================
// Modelo para almacenar metadatos de archivos subidos a Cloudinary
model FormularioArchivo {
  id           String @id @default(cuid())
  formularioId String

  // Información del archivo
  nombre      String // Nombre original del archivo
  tipoArchivo TipoArchivo
  mimeType    String // application/pdf, image/jpeg, video/mp4, etc.
  tamanio     Int // Tamaño en bytes

  // Datos de Cloudinary
  cloudinaryId   String @unique // public_id de Cloudinary
  cloudinaryUrl  String // URL segura del archivo
  cloudinaryType String // image, video, raw (para documentos)

  // Metadatos adicionales
  ancho    Int? // Solo para imágenes/videos
  alto     Int? // Solo para imágenes/videos
  duracion Float? // Solo para videos (en segundos)
  formato  String // jpg, png, pdf, mp4, etc.

  formulario FormularioCSSAnalisis @relation(fields: [formularioId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([formularioId])
  @@index([tipoArchivo])
}

// ==================== FORMULARIO STRADDLE CARRIER ANALYSIS MODEL ====================
// Formulario específico de Análisis Straddle Carrier
model FormularioStraddleCarrierAnalisis {
  id      String @id @default(cuid())
  visitId String @unique

  // 1. Datos del cliente
  razonSocial                String
  personaContacto            String
  email                      String
  direccion                  String
  localidad                  String
  provinciaEstado            String
  pais                       String
  codigoPostal               String
  website                    String?
  numeroIdentificacionFiscal String
  distribuidor               String?
  contactoDistribuidor       String?
  fechaCierre                DateTime?

  // 2. Cuadro 1 - Contenedores
  manejaContenedores        Boolean @default(false)
  manejaContenedoresIndiv   Boolean @default(false)
  dobleApilamiento          Boolean @default(false)
  // Tabla de tamaños (JSON: {size20ft, size30ft, size40ft, size45ft, size53ft} con selected y cantidad)
  contenedoresTamanios      Json?
  pesoMaximoContenedor      Float?
  infoAdicionalContenedores String? @db.Text

  // 3. Cuadro 2 - Carga especial
  manejaCargaEspecial     Boolean @default(false)
  productoMasLargo        Float?
  productoMasCorto        Float?
  productoMasAncho        Float?
  productoMasEstrecho     Float?
  puntosElevacionLongitud Float?
  puntosElevacionAncho    Float?
  pesoMaximoProductoLargo Float?
  pesoMaximoProductoCorto Float?
  productoMasAlto         Float?

  // 4. Otros
  zonasPasoAncho       Float?
  zonasPasoAlto        Float?
  condicionesPiso      String? @db.Text
  pisoPlano            Boolean @default(true)
  restriccionesAltura  Float?
  restriccionesAnchura Float?
  notasAdicionales     String? @db.Text

  // 5. Archivos adjuntos
  archivos FormularioArchivoStraddleCarrier[]

  visit Visit @relation(fields: [visitId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([visitId])
}

// ==================== ARCHIVOS DEL FORMULARIO STRADDLE CARRIER ====================
model FormularioArchivoStraddleCarrier {
  id           String @id @default(cuid())
  formularioId String

  // Información del archivo
  nombre      String
  tipoArchivo TipoArchivo
  mimeType    String
  tamanio     Int

  // Datos de Cloudinary
  cloudinaryId   String @unique
  cloudinaryUrl  String
  cloudinaryType String

  // Metadatos adicionales
  ancho    Int?
  alto     Int?
  duracion Float?
  formato  String

  formulario FormularioStraddleCarrierAnalisis @relation(fields: [formularioId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([formularioId])
  @@index([tipoArchivo])
}
